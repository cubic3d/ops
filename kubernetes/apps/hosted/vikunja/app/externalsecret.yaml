# yaml-language-server: $schema=https://schemaz.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vikunja
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    template:
      data:
        config.yaml: |-
          service:
            JWTSecret: {{ .v_jwt_secret }}
            publicurl: https://tasks.${domain}
            timezone: Europe/Berlin
            rootpath: /app/vikunja/
          files:
            basepath: ./files
          database:
            path: /db/vikunja.db
          mailer:
            enabled: true
            fromemail: noreply@${domain}
            host: {{ .m_smtp_server }}
            port: {{ .m_port }}
            username: {{ .m_username }}
            password: {{ .m_password }}
          log:
            http: off
          auth:
            local:
              enabled: false
            openid:
              enabled: true
              providers:
                - name: Yachthafen ID
                  authurl: https://auth.${domain}
                  clientid: vikunja
                  clientsecret: {{ .a_oidc_secret_vikunja_plain }}
          metrics:
            enabled: true
          defaultsettings:
            avatar_provider: gravatar
            email_reminders_enabled: true
            discoverable_by_name: true
            discoverable_by_email: true
            week_start: 1
  dataFrom:
    - extract:
        key: vikunja
      rewrite:
        - regexp:
            source: (.*)
            target: v_$1

    - extract:
        key: mailing
      rewrite:
        - regexp:
            source: (.*)
            target: m_$1

    - extract:
        key: authelia
      rewrite:
        - regexp:
            source: (.*)
            target: a_$1
