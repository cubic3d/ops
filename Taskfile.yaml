version: "3"

tasks:
  default:
    cmd: go-task -l

  k8s:mount:
    desc: Mounts a PVC to a temporary pod (k8s:mount ns=my-ns pvc=my-pvc)
    vars:
      ns: '{{ default "default" .ns }}'
      pvc: '{{ or .pvc (fail "PersistentVolumeClaim `pvc` is required") }}'
    preconditions:
      - sh: kubectl -n {{.ns}} get pvc {{.pvc}}
        msg: PersistentVolumeClaim "{{ .pvc }}" or namespace "{{ .ns }}" do not exist
    interactive: true
    cmd: |-
      kubectl run -n {{.ns}} debug-{{.pvc}} -i --tty --rm --image=null --privileged --overrides='
        {
          "apiVersion": "v1",
          "spec": {
            "containers": [
              {
                "name": "debug",
                "image": "ghcr.io/onedr0p/alpine:rolling",
                "command": [
                  "/bin/bash"
                ],
                "workingDir": "/data",
                "stdin": true,
                "stdinOnce": true,
                "tty": true,
                "volumeMounts": [
                  {
                    "name": "data",
                    "mountPath": "/data"
                  }
                ]
              }
            ],
            "volumes": [
              {
                "name": "data",
                "persistentVolumeClaim": {
                  "claimName": "{{.pvc}}"
                }
              }
            ],
            "restartPolicy": "Never"
          }
        }'

  volsync:run:
    desc: Runs an arbitrary restic command for a given ReplicationSource (volsync:list ns=my-ns rsrc=my-rsrc -- snapshots)
    vars:
      ns: '{{ default "default" .ns }}'
      rsrc: '{{ or .rsrc (fail "ReplicationSource `rsrc` is required") }}'
    preconditions:
      - sh: kubectl -n {{.ns}} get replicationsource {{.rsrc}}
        msg: ReplicationSource "{{ .rsrc }}" or namespace "{{ .ns }}" do not exist
    interactive: true
    cmd: |-
      kubectl run -n {{.ns}} volsync-list-{{.rsrc}} -i --tty --rm --image=null --privileged --overrides='
        {
          "apiVersion": "v1",
          "spec": {
            "containers": [
              {
                "name": "list",
                "image": "ghcr.io/restic/restic:latest",
                "args": {{ .CLI_ARGS | splitArgs | mustToJson }},
                "stdin": true,
                "stdinOnce": true,
                "tty": true,
                "envFrom": [
                  {
                    "secretRef": {
                      "name": "volsync-{{.rsrc}}"
                    }
                  }
                ]
              }
            ],
            "restartPolicy": "Never"
          }
        }'

  volsync:list:
    desc: Lists snapshots for a given ReplicationSource (volsync:list ns=my-ns rsrc=my-rsrc)
    cmds:
      - task: volsync:run
        vars:
          CLI_ARGS: snapshots

  volsync:latest:
    desc: Lists files for latest snapshot for a given ReplicationSource (volsync:latest ns=my-ns rsrc=my-rsrc)
    cmds:
      - task: volsync:run
        vars:
          CLI_ARGS: ls latest --long
